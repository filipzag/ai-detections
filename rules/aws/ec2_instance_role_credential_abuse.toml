[metadata]
creation_date = "2026-02-17"
maturity = "production"
updated_date = "2026-02-17"

[rule]
author = ["Elastic Security Research"]
description = "Detects when EC2 instance credentials are used to perform high-risk IAM modifications, indicating potential privilege escalation after credential theft from the Instance Metadata Service."
false_positives = [
  "Terraform or CloudFormation running on EC2 instances",
  "CI/CD pipelines with IAM provisioning capabilities",
  "AWS Systems Manager automation documents",
  "Legitimate infrastructure management tools"
]
from = "now-65m"
index = ["logs-aws.cloudtrail-*"]
language = "eql"
license = "Elastic License v2"
name = "EC2 Instance Role Credential Abuse for IAM Privilege Escalation"
risk_score = 88
rule_id = "c3d4e5f6-a7b8-4901-c234-56789abcdef3"
severity = "critical"
tags = [
  "Domain: Cloud",
  "Data Source: AWS",
  "Data Source: Amazon Web Services",
  "Data Source: AWS CloudTrail",
  "Use Case: Threat Detection",
  "Tactic: Privilege Escalation",
  "Tactic: Credential Access",
  "Platform: AWS"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
sequence by aws.cloudtrail.user_identity.access_key_id with maxspan=1h
[any where event.dataset == "aws.cloudtrail" and 
 aws.cloudtrail.user_identity.type == "AssumedRole" and
 aws.cloudtrail.user_identity.arn like "*:instance/*"]
[any where event.dataset == "aws.cloudtrail" and
 event.action in ("CreateAccessKey", "CreateUser", "AttachUserPolicy", 
                   "PutUserPolicy", "CreateRole", "AttachRolePolicy", 
                   "PutRolePolicy", "UpdateAssumeRolePolicy", "DeleteUser",
                   "DetachUserPolicy", "DeleteAccessKey") and
 event.outcome == "success"]
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

[[rule.threat.technique]]
id = "T1552"
name = "Unsecured Credentials"
reference = "https://attack.mitre.org/techniques/T1552/"

[[rule.threat.technique.subtechnique]]
id = "T1552.005"
name = "Cloud Instance Metadata API"
reference = "https://attack.mitre.org/techniques/T1552/005/"

[rule.threat.tactic]
id = "TA0006"
name = "Credential Access"
reference = "https://attack.mitre.org/tactics/TA0006/"

[[rule.threat]]
framework = "MITRE ATT&CK"

[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"

[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"

[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

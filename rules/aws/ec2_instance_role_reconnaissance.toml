[metadata]
creation_date = "2026-02-17"
maturity = "production"
updated_date = "2026-02-17"

[rule]
author = ["Elastic Security Research"]
description = "Detects when EC2 instance credentials are used for extensive reconnaissance activities, indicating post-compromise enumeration after credential theft from the Instance Metadata Service."
false_positives = [
  "Multi-region deployments with legitimate cross-region API calls",
  "Backup and disaster recovery solutions",
  "Security scanning tools running from EC2 instances",
  "AWS Config or compliance tools performing resource discovery"
]
from = "now-35m"
index = ["logs-aws.cloudtrail-*"]
language = "eql"
license = "Elastic License v2"
name = "EC2 Instance Role Used for AWS Reconnaissance Activity"
risk_score = 73
rule_id = "d4e5f6a7-b8c9-4012-d345-6789abcdef04"
severity = "high"
tags = [
  "Domain: Cloud",
  "Data Source: AWS",
  "Data Source: Amazon Web Services",
  "Data Source: AWS CloudTrail",
  "Use Case: Threat Detection",
  "Tactic: Discovery",
  "Tactic: Credential Access",
  "Platform: AWS"
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
sequence by aws.cloudtrail.user_identity.access_key_id with maxspan=30m
[any where event.dataset == "aws.cloudtrail" and
 aws.cloudtrail.user_identity.type == "AssumedRole" and
 aws.cloudtrail.user_identity.arn like "*:instance/*" and
 event.outcome == "success"]
[any where event.dataset == "aws.cloudtrail" and
 aws.cloudtrail.user_identity.type == "AssumedRole" and
 event.action in ("DescribeInstances", "DescribeSecurityGroups", "DescribeSecurityGroupRules",
                   "DescribeSnapshots", "CreateSnapshot", "ModifySnapshotAttribute",
                   "GetSecretValue", "GetParameter", "ListBuckets", "GetObject",
                   "DescribeDBClusters", "DescribeLogGroups", "ListResources") and
 event.outcome == "success"]
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

[[rule.threat.technique]]
id = "T1078"
name = "Valid Accounts"
reference = "https://attack.mitre.org/techniques/T1078/"

[[rule.threat.technique.subtechnique]]
id = "T1078.004"
name = "Cloud Accounts"
reference = "https://attack.mitre.org/techniques/T1078/004/"

[rule.threat.tactic]
id = "TA0001"
name = "Initial Access"
reference = "https://attack.mitre.org/tactics/TA0001/"

[[rule.threat]]
framework = "MITRE ATT&CK"

[[rule.threat.technique]]
id = "T1087"
name = "Account Discovery"
reference = "https://attack.mitre.org/techniques/T1087/"

[[rule.threat.technique]]
id = "T1580"
name = "Cloud Infrastructure Discovery"
reference = "https://attack.mitre.org/techniques/T1580/"

[rule.threat.tactic]
id = "TA0007"
name = "Discovery"
reference = "https://attack.mitre.org/tactics/TA0007/"

[metadata]
creation_date = "2026/02/19"
integration = ["endpoint"]
maturity = "production"
updated_date = "2026/02/19"

[rule]
author = ["AI Detection Engineer"]
description = """
Detects modification of /etc/sudoers or files under /etc/sudoers.d/ to add NOPASSWD entries via process
execution. NOPASSWD entries allow users to execute commands as root without a password, making this a
high-confidence indicator of privilege escalation or persistence. Covers shell redirection, tee, visudo,
and in-place editing via sed/awk/perl.
"""
from = "now-9m"
index = ["logs-endpoint.events.process*"]
language = "eql"
license = "Elastic License v2"
name = "Linux Sudoers NOPASSWD Entry Modification"
references = [
    "https://attack.mitre.org/techniques/T1548/003/",
    "https://help.ubuntu.com/community/Sudoers",
]
risk_score = 90
rule_id = "f7c3a1d2-8e4b-4f9a-b2c5-1d6e7f8a9b0c"
severity = "critical"
tags = [
    "Domain: Endpoint",
    "OS: Linux",
    "Use Case: Threat Detection",
    "Tactic: Privilege Escalation",
    "Tactic: Persistence",
    "Data Source: Elastic Defend",
]
timestamp_override = "event.ingested"
type = "eql"

query = '''
process where host.os.type == "linux" and event.type == "start" and event.action == "exec" and
  (
    /* Shell writing NOPASSWD to sudoers via redirection */
    (
      process.name in ("bash", "sh", "zsh", "dash", "ksh") and
      process.command_line : ("*NOPASSWD*sudoers*", "*sudoers*NOPASSWD*", "*sudoers.d*NOPASSWD*")
    ) or
    /* tee writing directly to sudoers */
    (
      process.name == "tee" and
      process.args : ("/etc/sudoers", "/etc/sudoers.d/*")
    ) or
    /* visudo with -f flag targeting sudoers.d */
    (
      process.name == "visudo" and
      process.args : "-f" and
      process.args : "/etc/sudoers.d/*"
    ) or
    /* sed/awk/perl in-place editing of sudoers with NOPASSWD */
    (
      process.name in ("sed", "awk", "perl") and
      process.command_line : "*NOPASSWD*" and
      process.args : ("/etc/sudoers", "/etc/sudoers.d/*")
    )
  )
'''

[[rule.threat]]
framework = "MITRE ATT&CK"

[[rule.threat.technique]]
id = "T1548"
name = "Abuse Elevation Control Mechanism"
reference = "https://attack.mitre.org/techniques/T1548/"

[[rule.threat.technique.subtechnique]]
id = "T1548.003"
name = "Sudo and Sudo Caching"
reference = "https://attack.mitre.org/techniques/T1548/003/"

[rule.threat.tactic]
id = "TA0004"
name = "Privilege Escalation"
reference = "https://attack.mitre.org/tactics/TA0004/"

[[rule.threat]]
framework = "MITRE ATT&CK"

[rule.threat.tactic]
id = "TA0003"
name = "Persistence"
reference = "https://attack.mitre.org/tactics/TA0003/"
